<!DOCTYPE html><html><head><title>IRC channel logs</title><style>html {
  background: #fdfdfd;
}

h1 {
  font-weight: 300;
}

h2 {
  font-weight: 200;
}

h3 {
  padding: .5em 0;
  border-top: 3px dotted #ddd;
  margin-bottom: 0;
}

form {
  width: 400px;
  display: flex;
}

input {
  width: 100%;
  display: flex;
  border-radius: .25em 0 0 .25em;
  border: 1px solid #aaa;
  border-right: 0;
  padding: 0.5em;
}

button {
  display: flex;
  border-radius: 0 .25em .25em 0;
  background-color: #007bff;
  border: 1px solid #007bff;
  padding: .5em;
  cursor: pointer;
  color: white;
}

button:hover {
  background-color: #0069d9;
  border-color: #0062cc;
}

a {
  color: #007bff;
  text-decoration: none;
}

a:hover {
  text-decoration: underline;
}

h4 {
  margin-bottom: .5em;
}

table td {
  padding: 0.75em;
}

table tr:hover {
  background: #eee;
}

.year {
  display: table;
}

.month {
  display: table-cell;
  padding-right: 1em;
}

ul {
  margin: 0;
  padding: 0;
  list-style: none;
}

.nick {
  padding-right: 0.6rem;
  font-weight: bold;
  text-align: right;
  width: 13rem;
  display: table-cell;
}

.nick a {
  color: inherit;
  text-decoration: none;
}

.message {
  display: table-cell;
  padding-left: 0.6rem;
  border-left: 2px solid #333;
}

.notice {
  color: #859900;
  font-style: italic;
}

.line {
  line-height: 1.8rem;
  display: table;
}

#logs {
  margin-top: 1.5rem;
  padding: 1.5rem;
}
</style></head><body><h1>IRC channel logs</h1><h2>2024-01-05.log</h2><p><a href="/bootstrappable">back to list of logs</a></p><div id="logs"><div class="line" id="000125"><span class="nick" style="color:#389600"><a href="#000125" label="[00:01:25]">&lt;stikonas&gt;</a></span><span class="message">isn't M2-Planet doing this</span></div><div class="line" id="000145"><span class="nick" style="color:#389600"><a href="#000145" label="[00:01:45]">&lt;stikonas&gt;</a></span><span class="message">(just without backtracking)</span></div><div class="line" id="000353"><span class="nick" style="color:#8dd3c7"><a href="#000353" label="[00:03:53]">&lt;mihi&gt;</a></span><span class="message">Looking at the source of M2-Planet now, seems that it is mostly doing that already. Only that you have only one &quot;void additive_expr_stub()&quot; which is doing all arithmetics, unlike the usual differentiation between atom, term, factor, to get correct precedence.</span></div><div class="line" id="000807"><span class="nick" style="color:#8dd3c7"><a href="#000807" label="[00:08:07]">&lt;mihi&gt;</a></span><span class="message">Also that callback in arithmetic_recursion looks unfamiliar to me. Is that some Scheme-style tail call elimination?</span></div><div class="line" id="001019"><span class="nick" style="color:#8dd3c7"><a href="#001019" label="[00:10:19]">&lt;mihi&gt;</a></span><span class="message">so it might interfere with proper recursive descent parsing or not, probably need to try.</span></div><div class="line" id="001512"><span class="nick" style="color:#389600"><a href="#001512" label="[00:15:12]">&lt;stikonas&gt;</a></span><span class="message">hmm, does anybody know here how to check whether file exists in UEFI?</span></div><div class="line" id="001542"><span class="nick" style="color:#389600"><a href="#001542" label="[00:15:42]">&lt;stikonas&gt;</a></span><span class="message">I'm trying to just open the file using <a rel="nofollow" href="https://uefi.org/specs/UEFI/2.10/13_Protocols_Media_Access.html#efi-file-protocol-open">https://uefi.org/specs/UEFI/2.10/13_Protocols_Media_Access.html#efi-file-protocol-open</a>  and without EFI_FILE_MODE_CREATE</span></div><div class="line" id="001552"><span class="nick" style="color:#389600"><a href="#001552" label="[00:15:52]">&lt;stikonas&gt;</a></span><span class="message">but instead of returning error, it seems to create an empty file...</span></div><div class="line" id="002402"><span class="nick" style="color:#2e2a4a"><a href="#002402" label="[00:24:02]">&lt;rickmasters&gt;</a></span><span class="message">stikonas: assuming you set the open for READ you should get FILE_NOT_FOUND - otherwise open the parent directory and read the entries?</span></div><div class="line" id="002427"><span class="nick" style="color:#389600"><a href="#002427" label="[00:24:27]">&lt;stikonas&gt;</a></span><span class="message">well,  I'll have to double check if all the parameters are set to the right values</span></div><div class="line" id="002538"><span class="nick" style="color:#389600"><a href="#002538" label="[00:25:38]">&lt;stikonas&gt;</a></span><span class="message">somehow I have an impression that something goes wrong with the values somewhere</span></div><div class="line" id="005357"><span class="nick" style="color:#389600"><a href="#005357" label="[00:53:57]">&lt;stikonas&gt;</a></span><span class="message">hmm, so somehow all the files are open as write...</span></div><div class="line" id="005430"><span class="nick" style="color:#389600"><a href="#005430" label="[00:54:30]">&lt;stikonas&gt;</a></span><span class="message">flag = 0 but we go to if branch here <a rel="nofollow" href="https://github.com/oriansj/M2libc/blob/main/uefi/fcntl.c#L55">https://github.com/oriansj/M2libc/blob/main/uefi/fcntl.c#L55</a> </span></div><div class="line" id="005551"><span class="nick" style="color:#389600"><a href="#005551" label="[00:55:51]">&lt;stikonas&gt;</a></span><span class="message">I wonder if it's another M2-Planet bug</span></div><div class="line" id="011049"><span class="nick" style="color:#389600"><a href="#011049" label="[01:10:49]">&lt;stikonas&gt;</a></span><span class="message">replacing if(flag == O_WRONLY|O_CREAT|O_TRUNC) with if(flag == (O_WRONLY|O_CREAT|O_TRUNC)) seems to help</span></div><div class="line" id="011051"><span class="nick" style="color:#389600"><a href="#011051" label="[01:10:51]">&lt;stikonas&gt;</a></span><span class="message">strange...</span></div><div class="line" id="011056"><span class="nick" style="color:#389600"><a href="#011056" label="[01:10:56]">&lt;stikonas&gt;</a></span><span class="message">oriansj: any ideas why?</span></div><div class="line" id="011115"><span class="nick" style="color:#389600"><a href="#011115" label="[01:11:15]">&lt;stikonas&gt;</a></span><span class="message">another operator precedence issue?</span></div><div class="line" id="011205"><span class="nick" style="color:#6b8072"><a href="#011205" label="[01:12:05]">&lt;oriansj&gt;</a></span><span class="message">no as it is a bitwsie or</span></div><div class="line" id="011234"><span class="nick" style="color:#389600"><a href="#011234" label="[01:12:34]">&lt;stikonas&gt;</a></span><span class="message">oh yes</span></div><div class="line" id="011236"><span class="nick" style="color:#389600"><a href="#011236" label="[01:12:36]">&lt;stikonas&gt;</a></span><span class="message">so code bug...</span></div><div class="line" id="011243"><span class="nick" style="color:#389600"><a href="#011243" label="[01:12:43]">&lt;stikonas&gt;</a></span><span class="message">indeed, == has higher priority</span></div><div class="line" id="011259"><span class="nick" style="color:#389600"><a href="#011259" label="[01:12:59]">&lt;stikonas&gt;</a></span><span class="message">anyway, this fixes mes to print --help and --version (at the very least)</span></div><div class="line" id="011307"><span class="nick" style="color:#389600"><a href="#011307" label="[01:13:07]">&lt;stikonas&gt;</a></span><span class="message">though exposes some bug in stage0-posix...</span></div><div class="line" id="011326"><span class="nick" style="color:#389600"><a href="#011326" label="[01:13:26]">&lt;stikonas&gt;</a></span><span class="message">where it fails with ./amd64/artifact/M2-1-footer.M1 not found...</span></div><div class="line" id="011351"><span class="nick" style="color:#389600"><a href="#011351" label="[01:13:51]">&lt;stikonas&gt;</a></span><span class="message">probably just need to fix kaem script</span></div><div class="line" id="011437"><span class="nick" style="color:#6b8072"><a href="#011437" label="[01:14:37]">&lt;oriansj&gt;</a></span><span class="message">== is supposed to have ahigher priorty than |</span></div><div class="line" id="011455"><span class="nick" style="color:#389600"><a href="#011455" label="[01:14:55]">&lt;stikonas&gt;</a></span><span class="message">yeah, my mistake...</span></div><div class="line" id="011503"><span class="nick" style="color:#389600"><a href="#011503" label="[01:15:03]">&lt;stikonas&gt;</a></span><span class="message">anyway, I have a fix now</span></div><div class="line" id="011505"><span class="nick" style="color:#389600"><a href="#011505" label="[01:15:05]">&lt;stikonas&gt;</a></span><span class="message">preparing PR</span></div><div class="line" id="011630"><span class="nick" style="color:#389600"><a href="#011630" label="[01:16:30]">&lt;stikonas&gt;</a></span><span class="message">oriansj: <a rel="nofollow" href="https://github.com/oriansj/M2libc/pull/52">https://github.com/oriansj/M2libc/pull/52</a> </span></div><div class="line" id="011642"><span class="nick" style="color:#389600"><a href="#011642" label="[01:16:42]">&lt;stikonas&gt;</a></span><span class="message">ir also adds a non dummy access()</span></div><div class="line" id="011645"><span class="nick" style="color:#389600"><a href="#011645" label="[01:16:45]">&lt;stikonas&gt;</a></span><span class="message">which is required by mes</span></div><div class="line" id="012119"><span class="nick" style="color:#389600"><a href="#012119" label="[01:21:19]">&lt;stikonas&gt;</a></span><span class="message">argh, something is not good...</span></div><div class="line" id="012145"><span class="nick" style="color:#389600"><a href="#012145" label="[01:21:45]">&lt;stikonas&gt;</a></span><span class="message">M2-Mesoplanet is now failing to build stuff</span></div><div class="line" id="012222"><span class="nick" style="color:#389600"><a href="#012222" label="[01:22:22]">&lt;stikonas&gt;</a></span><span class="message">need to investigate first...</span></div><div class="line" id="012921"><span class="nick" style="color:#389600"><a href="#012921" label="[01:29:21]">&lt;stikonas&gt;</a></span><span class="message">maybe it crashes now...</span></div><div class="line" id="012930"><span class="nick" style="color:#389600"><a href="#012930" label="[01:29:30]">&lt;stikonas&gt;</a></span><span class="message">there is no useful error message</span></div><div class="line" id="014048"><span class="nick" style="color:#6b8072"><a href="#014048" label="[01:40:48]">&lt;oriansj&gt;</a></span><span class="message">well I think I properly fixed the +/* priority; we probably will need to sit down one of these days and fix the rest (as all of the bitwise have different priorities)</span></div><div class="line" id="014148"><span class="nick" style="color:#389600"><a href="#014148" label="[01:41:48]">&lt;stikonas&gt;</a></span><span class="message">nice</span></div><div class="line" id="014244"><span class="nick" style="color:#389600"><a href="#014244" label="[01:42:44]">&lt;stikonas&gt;</a></span><span class="message">I probably won't solve Mesoplanet problem today...</span></div><div class="line" id="014255"><span class="nick" style="color:#389600"><a href="#014255" label="[01:42:55]">&lt;stikonas&gt;</a></span><span class="message">but still, made some progress</span></div><div class="line" id="014319"><span class="nick" style="color:#389600"><a href="#014319" label="[01:43:19]">&lt;stikonas&gt;</a></span><span class="message">but it's always step forward and at the same time step backwards :(</span></div><div class="line" id="014327"><span class="nick" style="color:#389600"><a href="#014327" label="[01:43:27]">&lt;stikonas&gt;</a></span><span class="message">which I then need to debug...</span></div><div class="line" id="014340"><span class="nick" style="color:#6b8072"><a href="#014340" label="[01:43:40]">&lt;oriansj&gt;</a></span><span class="message">only test1000 got different checksums; so it is unlikely that I introduced any regressions</span></div><div class="line" id="014553"><span class="nick" style="color:#6b8072"><a href="#014553" label="[01:45:53]">&lt;oriansj&gt;</a></span><span class="message">commit is up</span></div><div class="line" id="014751"><span class="nick" style="color:#389600"><a href="#014751" label="[01:47:51]">&lt;stikonas&gt;</a></span><span class="message">yeah, that testcase is working now</span></div><div class="line" id="015201"><span class="nick" style="color:#389600"><a href="#015201" label="[01:52:01]">&lt;stikonas&gt;</a></span><span class="message">oriansj: and in stage0-posix on M2-Planet checksum changed</span></div><div class="line" id="015215"><span class="nick" style="color:#6b8072"><a href="#015215" label="[01:52:15]">&lt;oriansj&gt;</a></span><span class="message">well yes, the source code changed</span></div><div class="line" id="015216"><span class="nick" style="color:#389600"><a href="#015216" label="[01:52:16]">&lt;stikonas&gt;</a></span><span class="message">so I think your commit is good</span></div><div class="line" id="015234"><span class="nick" style="color:#389600"><a href="#015234" label="[01:52:34]">&lt;stikonas&gt;</a></span><span class="message">yes, but that also means were did not have wrong behaviour in other files</span></div><div class="line" id="015248"><span class="nick" style="color:#389600"><a href="#015248" label="[01:52:48]">&lt;stikonas&gt;</a></span><span class="message">probably used brackets everywhere...</span></div><div class="line" id="015301"><span class="nick" style="color:#389600"><a href="#015301" label="[01:53:01]">&lt;stikonas&gt;</a></span><span class="message">anyway, I think I know why M2-Mesoplanet crashes</span></div><div class="line" id="015308"><span class="nick" style="color:#389600"><a href="#015308" label="[01:53:08]">&lt;stikonas&gt;</a></span><span class="message">it uses access for folder</span></div><div class="line" id="015309"><span class="nick" style="color:#6b8072"><a href="#015309" label="[01:53:09]">&lt;oriansj&gt;</a></span><span class="message">well you are very good at using () everywhere it mattered</span></div><div class="line" id="015326"><span class="nick" style="color:#389600"><a href="#015326" label="[01:53:26]">&lt;stikonas&gt;</a></span><span class="message">and I probably only implemented it for files in UEFI</span></div><div class="line" id="015356"><span class="nick" style="color:#6b8072"><a href="#015356" label="[01:53:56]">&lt;oriansj&gt;</a></span><span class="message">a generally reasonable assumption that holds all the way up  til then</span></div><div class="line" id="015443"><span class="nick" style="color:#389600"><a href="#015443" label="[01:54:43]">&lt;stikonas&gt;</a></span><span class="message">Ill fix it tomorrow...</span></div><div class="line" id="015459"><span class="nick" style="color:#389600"><a href="#015459" label="[01:54:59]">&lt;stikonas&gt;</a></span><span class="message">understanding the cause is usually most of the way to fixing the bug</span></div><div class="line" id="015523"><span class="nick" style="color:#6b8072"><a href="#015523" label="[01:55:23]">&lt;oriansj&gt;</a></span><span class="message">especially in bootstrapping</span></div><div class="line" id="015555"><span class="nick" style="color:#389600"><a href="#015555" label="[01:55:55]">&lt;stikonas&gt;</a></span><span class="message">and then we'll have mes --help working i uefi</span></div><div class="line" id="015604"><span class="nick" style="color:#389600"><a href="#015604" label="[01:56:04]">&lt;stikonas&gt;</a></span><span class="message">(and possibly more)</span></div><div class="line" id="020058"><span class="nick" style="color:#389600"><a href="#020058" label="[02:00:58]">&lt;stikonas&gt;</a></span><span class="message">well, strictly speaking mes-m2 not mes</span></div><div class="line" id="023400"><span class="nick" style="color:#389600"><a href="#023400" label="[02:34:00]">&lt;stikonas&gt;</a></span><span class="message">oh, the bug is due to mkstemp not working</span></div><div class="line" id="023415"><span class="nick" style="color:#389600"><a href="#023415" label="[02:34:15]">&lt;stikonas&gt;</a></span><span class="message">probabl because its trying to open files in (up to now) unsupported mode</span></div><div class="line" id="023425"><span class="nick" style="color:#389600"><a href="#023425" label="[02:34:25]">&lt;stikonas&gt;</a></span><span class="message">open(template, O_RDWR | O_CREAT | O_EXCL, 00600);</span></div><div class="line" id="023428"><span class="nick" style="color:#389600"><a href="#023428" label="[02:34:28]">&lt;stikonas&gt;</a></span><span class="message">I guess O_EXCL</span></div><div class="line" id="042359"><span class="nick" style="color:#6b8072"><a href="#042359" label="[04:23:59]">&lt;oriansj&gt;</a></span><span class="message">well mkstemp is a kind of ugly hack in M2libc; if we were to do the proper thing, we would be using access to identify what files already exist that match our template guesses and then attempt to open the first one available. the use of O_EXCL was to esnure if anyone else is working with a file name we guess, that we would avoid accidentially of stomping all over the contents if someone else was using it; otherwise reusing lower numbers</span></div><div class="line" id="042359"><span class="nick" style="color:#6b8072"><a href="#042359" label="[04:23:59]">&lt;oriansj&gt;</a></span><span class="message">wouldn't be a problem.</span></div><div class="line" id="063009"><span class="nick" style="color:#80b1d3"><a href="#063009" label="[06:30:09]">&lt;pabs3&gt;</a></span><span class="message">Googulator: please ping me if you find the GHC CVS repo; would like to get it archived by Software Heritage and archive.org <a rel="nofollow" href="https://archive.softwareheritage.org/">https://archive.softwareheritage.org/</a>  <a rel="nofollow" href="https://wiki.archiveteam.org/index.php/Codearchiver">https://wiki.archiveteam.org/index.php/Codearchiver</a> </span></div><div class="line" id="083841"><span class="nick" style="color:#6d2462"><a href="#083841" label="[08:38:41]">&lt;Mikaku&gt;</a></span><span class="message">rickmasters: OK</span></div><div class="line" id="084019"><span class="nick" style="color:#234e69"><a href="#084019" label="[08:40:19]">&lt;muurkha&gt;</a></span><span class="message"> <a rel="nofollow" href="https://github.com/cksystemsteaching/selfie">https://github.com/cksystemsteaching/selfie</a>  is one of the most amazing bootstrapping projects I've ever seen</span></div><div class="line" id="084024"><span class="nick" style="color:#234e69"><a href="#084024" label="[08:40:24]">&lt;muurkha&gt;</a></span><span class="message">I think we've talked about it in here before</span></div><div class="line" id="084254"><span class="nick" style="color:#234e69"><a href="#084254" label="[08:42:54]">&lt;muurkha&gt;</a></span><span class="message">Selfie is written in a tiny subset of C called C*, and contains a compiler from C* to standard ELF RISC-V binaries for a RISC-V subset called RISC-U, a CPU emulator for RISC-U, and a hypervisor for RISC-U under which Selfie can run</span></div><div class="line" id="084422"><span class="nick" style="color:#234e69"><a href="#084422" label="[08:44:22]">&lt;muurkha&gt;</a></span><span class="message">it's 12000 lines of C</span></div><div class="line" id="185439"><span class="nick" style="color:#6b8072"><a href="#185439" label="[18:54:39]">&lt;oriansj&gt;</a></span><span class="message">muurkha: well writing C subsets is quite easy and fun to do; M2-Planet is only 4,597 lines of Code, M2libc is around 5.6Kloc of Code; so just writing a C standard library that supports multiple architectures ends up being more work than creating a C compiler that supports multiple architectures.</span></div><div class="line" id="190159"><span class="nick" style="color:#6b8072"><a href="#190159" label="[19:01:59]">&lt;oriansj&gt;</a></span><span class="message">it is only when one starts having to deal with preprocessor crap does writing a C compiler get &quot;hard&quot;; everything else is just creating lists and reading index values</span></div><div class="line" id="194756"><span class="nick" style="color:#389600"><a href="#194756" label="[19:47:56]">&lt;stikonas&gt;</a></span><span class="message">well, but M2libc now support both POSIX and UEFI</span></div><div class="line" id="194813"><span class="nick" style="color:#389600"><a href="#194813" label="[19:48:13]">&lt;stikonas&gt;</a></span><span class="message">plus quite a few different architectures...</span></div><div class="line" id="201113"><span class="nick" style="color:#234e69"><a href="#201113" label="[20:11:13]">&lt;muurkha&gt;</a></span><span class="message">oriansj: yes, but those 12k lines include not only the compiler and the libc but also the CPU and the OS</span></div><div class="line" id="201403"><span class="nick" style="color:#6c3d55"><a href="#201403" label="[20:14:03]">&lt;Piraty&gt;</a></span><span class="message">fossy: pig</span></div><div class="line" id="201513"><span class="nick" style="color:#6c3d55"><a href="#201513" label="[20:15:13]">&lt;Piraty&gt;</a></span><span class="message">* ping</span></div><div class="line" id="201550"><span class="nick" style="color:#234e69"><a href="#201550" label="[20:15:50]">&lt;muurkha&gt;</a></span><span class="message">heh</span></div><div class="line" id="201718"><span class="nick" style="color:#389600"><a href="#201718" label="[20:17:18]">&lt;stikonas&gt;</a></span><span class="message">Piraty: if it's general question just ask, others might be able to answer</span></div><div class="line" id="202121"><span class="nick" style="color:#6c3d55"><a href="#202121" label="[20:21:21]">&lt;Piraty&gt;</a></span><span class="message">it's special to fossy, i'll state it anyway</span></div><div class="line" id="202121"><span class="nick" style="color:#6c3d55"><a href="#202121" label="[20:21:21]">&lt;Piraty&gt;</a></span><span class="message">fossy: i see you are maintainer of some abi-* tooling of lvc . did you put it to work somewhere, auto-building the packages?</span></div><div class="line" id="202131"><span class="nick" style="color:#6c3d55"><a href="#202131" label="[20:21:31]">&lt;Piraty&gt;</a></span><span class="message">(maintainer in void linux)</span></div><div class="line" id="203952"><span class="nick" style="color:#389600"><a href="#203952" label="[20:39:52]">&lt;stikonas&gt;</a></span><span class="message">hmm, that M2libc/UEFI fix of operator precedence mode seems to be causing a chain of new issues :(</span></div><div class="line" id="204130"><span class="nick" style="color:#389600"><a href="#204130" label="[20:41:30]">&lt;stikonas&gt;</a></span><span class="message">the latest problem is that somehow remove(name) which calls unlink doesn't work :(</span></div><div class="line" id="214450"><span class="nick" style="color:#6b8072"><a href="#214450" label="[21:44:50]">&lt;oriansj&gt;</a></span><span class="message">odd as that is just passing a string and if that was broken half of the tests would have failed</span></div><div class="line" id="214527"><span class="nick" style="color:#6b8072"><a href="#214527" label="[21:45:27]">&lt;oriansj&gt;</a></span><span class="message">would the issue be in the logic making the string which is then passed to remove?</span></div><div class="line" id="223557"><span class="nick" style="color:#389600"><a href="#223557" label="[22:35:57]">&lt;stikonas&gt;</a></span><span class="message">oriansj: not sure yet, so far in UEFI it seems to return 2</span></div><div class="line" id="223633"><span class="nick" style="color:#389600"><a href="#223633" label="[22:36:33]">&lt;stikonas&gt;</a></span><span class="message">which is EFI_WARN_DELETE_FAILURE</span></div><div class="line" id="223659"><span class="nick" style="color:#389600"><a href="#223659" label="[22:36:59]">&lt;stikonas&gt;</a></span><span class="message">so the question is why did it work before that operator precedence fix...</span></div><div class="line" id="223753"><span class="nick" style="color:#389600"><a href="#223753" label="[22:37:53]">&lt;stikonas&gt;</a></span><span class="message">I wonder if it's something to do with file already being open</span></div><div class="line" id="223800"><span class="nick" style="color:#389600"><a href="#223800" label="[22:38:00]">&lt;stikonas&gt;</a></span><span class="message">maybe UEFI doesn't like that...</span></div><div class="line" id="223929"><span class="nick" style="color:#389600"><a href="#223929" label="[22:39:29]">&lt;stikonas&gt;</a></span><span class="message">but adding fclose(tempfile); doesn't make it any better, I  think fclose then fails</span></div><div class="line" id="223956"><span class="nick" style="color:#389600"><a href="#223956" label="[22:39:56]">&lt;stikonas&gt;</a></span><span class="message">oh, that's because we are already closing it</span></div><div class="line" id="223959"><span class="nick" style="color:#389600"><a href="#223959" label="[22:39:59]">&lt;stikonas&gt;</a></span><span class="message">nevermind fclose then</span></div><div class="line" id="224140"><span class="nick" style="color:#389600"><a href="#224140" label="[22:41:40]">&lt;stikonas&gt;</a></span><span class="message">I have a new theory</span></div><div class="line" id="224141"><span class="nick" style="color:#389600"><a href="#224141" label="[22:41:41]">&lt;stikonas&gt;</a></span><span class="message">let me check</span></div><div class="line" id="224154"><span class="nick" style="color:#389600"><a href="#224154" label="[22:41:54]">&lt;stikonas&gt;</a></span><span class="message">perhaps I didn't adjust paths after &quot;cd&quot; call</span></div><div class="line" id="224328"><span class="nick" style="color:#389600"><a href="#224328" label="[22:43:28]">&lt;stikonas&gt;</a></span><span class="message">yeah, that's what is happening</span></div><div class="line" id="224352"><span class="nick" style="color:#389600"><a href="#224352" label="[22:43:52]">&lt;stikonas&gt;</a></span><span class="message">I'm trying to remove ../amd64/artifact/M2-Mesoplanet-000000</span></div><div class="line" id="224406"><span class="nick" style="color:#389600"><a href="#224406" label="[22:44:06]">&lt;stikonas&gt;</a></span><span class="message">that .. takes me outside rootdir</span></div><div class="line" id="224509"><span class="nick" style="color:#389600"><a href="#224509" label="[22:45:09]">&lt;stikonas&gt;</a></span><span class="message">hmm, or maybe not...</span></div><div class="line" id="224516"><span class="nick" style="color:#389600"><a href="#224516" label="[22:45:16]">&lt;stikonas&gt;</a></span><span class="message">hmm</span></div><div class="line" id="224716"><span class="nick" style="color:#389600"><a href="#224716" label="[22:47:16]">&lt;stikonas&gt;</a></span><span class="message">oh, it comes from kaem script...</span></div><div class="line" id="224720"><span class="nick" style="color:#389600"><a href="#224720" label="[22:47:20]">&lt;stikonas&gt;</a></span><span class="message">so maybe the fix is trivial</span></div><div class="line" id="225136"><span class="nick" style="color:#389600"><a href="#225136" label="[22:51:36]">&lt;stikonas&gt;</a></span><span class="message">still fails :(</span></div><div class="line" id="225827"><span class="nick" style="color:#6b8072"><a href="#225827" label="[22:58:27]">&lt;oriansj&gt;</a></span><span class="message">try --dirty-mode to make M2-Mesoplanet ignore the remove entirely</span></div><div class="line" id="230228"><span class="nick" style="color:#389600"><a href="#230228" label="[23:02:28]">&lt;stikonas&gt;</a></span><span class="message">oriansj: well, that's kind of what happens</span></div><div class="line" id="230237"><span class="nick" style="color:#389600"><a href="#230237" label="[23:02:37]">&lt;stikonas&gt;</a></span><span class="message">and combned with no truncate support</span></div><div class="line" id="230300"><span class="nick" style="color:#389600"><a href="#230300" label="[23:03:00]">&lt;stikonas&gt;</a></span><span class="message">when I'm building 2nd file (match.c) it ends up with part new file and part previous file</span></div><div class="line" id="230351"><span class="nick" style="color:#389600"><a href="#230351" label="[23:03:51]">&lt;stikonas&gt;</a></span><span class="message">anyway, let's see what happens with --dirty-mode</span></div><div class="line" id="230436"><span class="nick" style="color:#389600"><a href="#230436" label="[23:04:36]">&lt;stikonas&gt;</a></span><span class="message">same...</span></div><div class="line" id="230752"><span class="nick" style="color:#6b8072"><a href="#230752" label="[23:07:52]">&lt;oriansj&gt;</a></span><span class="message">odd as the offsets should start at zero when openning the file as just w</span></div><div class="line" id="230831"><span class="nick" style="color:#389600"><a href="#230831" label="[23:08:31]">&lt;stikonas&gt;</a></span><span class="message">ofsset is at zero</span></div><div class="line" id="230836"><span class="nick" style="color:#389600"><a href="#230836" label="[23:08:36]">&lt;stikonas&gt;</a></span><span class="message">but the 2nd file is shorter</span></div><div class="line" id="230843"><span class="nick" style="color:#389600"><a href="#230843" label="[23:08:43]">&lt;stikonas&gt;</a></span><span class="message">and when opening right now O_TRUNC is ignored</span></div><div class="line" id="230855"><span class="nick" style="color:#389600"><a href="#230855" label="[23:08:55]">&lt;stikonas&gt;</a></span><span class="message">well, perhaps I could try to fix it</span></div><div class="line" id="230921"><span class="nick" style="color:#389600"><a href="#230921" label="[23:09:21]">&lt;stikonas&gt;</a></span><span class="message">but that's somewhat unrelated to delete not working</span></div><div class="line" id="230930"><span class="nick" style="color:#389600"><a href="#230930" label="[23:09:30]">&lt;stikonas&gt;</a></span><span class="message">well, I guess i need to insert more debug prints...</span></div><div class="line" id="230936"><span class="nick" style="color:#6b8072"><a href="#230936" label="[23:09:36]">&lt;oriansj&gt;</a></span><span class="message">well fdopen doesn't do O_TRUNC</span></div><div class="line" id="231043"><span class="nick" style="color:#389600"><a href="#231043" label="[23:10:43]">&lt;stikonas&gt;</a></span><span class="message">yeah, but on UEFI  O_TRUNC is not that easily exposed...</span></div><div class="line" id="231057"><span class="nick" style="color:#389600"><a href="#231057" label="[23:10:57]">&lt;stikonas&gt;</a></span><span class="message">you have to manually set file length to 0 first</span></div><div class="line" id="231108"><span class="nick" style="color:#389600"><a href="#231108" label="[23:11:08]">&lt;stikonas&gt;</a></span><span class="message">so all files are open in just one of the two modes</span></div><div class="line" id="231130"><span class="nick" style="color:#389600"><a href="#231130" label="[23:11:30]">&lt;stikonas&gt;</a></span><span class="message">mode = EFI_FILE_MODE_CREATE | EFI_FILE_MODE_WRITE | EFI_FILE_MODE_READ or  EFI_FILE_MODE_READ</span></div><div class="line" id="231201"><span class="nick" style="color:#389600"><a href="#231201" label="[23:12:01]">&lt;stikonas&gt;</a></span><span class="message">so right now whether we are passing O_TRUNC or not doesn't make any difference</span></div><div class="line" id="231204"><span class="nick" style="color:#389600"><a href="#231204" label="[23:12:04]">&lt;stikonas&gt;</a></span><span class="message">(though that can be fixed)</span></div><div class="line" id="231939"><span class="nick" style="color:#6b8072"><a href="#231939" label="[23:19:39]">&lt;oriansj&gt;</a></span><span class="message">in uefi/fcntl.c you would want () around O_WRONLY|O_CREAT|O_TRUNC</span></div><div class="line" id="232203"><span class="nick" style="color:#389600"><a href="#232203" label="[23:22:03]">&lt;stikonas&gt;</a></span><span class="message">yeah, that is fixed in my temp change</span></div><div class="line" id="232208"><span class="nick" style="color:#389600"><a href="#232208" label="[23:22:08]">&lt;stikonas&gt;</a></span><span class="message">which we discussed yesterday</span></div><div class="line" id="232214"><span class="nick" style="color:#389600"><a href="#232214" label="[23:22:14]">&lt;stikonas&gt;</a></span><span class="message">but that suddenly broke other thigns</span></div><div class="line" id="232221"><span class="nick" style="color:#389600"><a href="#232221" label="[23:22:21]">&lt;stikonas&gt;</a></span><span class="message">maybe they worked by accident</span></div><div class="line" id="232413"><span class="nick" style="color:#389600"><a href="#232413" label="[23:24:13]">&lt;stikonas&gt;</a></span><span class="message">oriansj: this is my current change <a rel="nofollow" href="https://paste.debian.net/1303182/">https://paste.debian.net/1303182/</a> </span></div><div class="line" id="232442"><span class="nick" style="color:#389600"><a href="#232442" label="[23:24:42]">&lt;stikonas&gt;</a></span><span class="message">sorry, that's just half of it</span></div><div class="line" id="232446"><span class="nick" style="color:#389600"><a href="#232446" label="[23:24:46]">&lt;stikonas&gt;</a></span><span class="message">one more try</span></div><div class="line" id="232601"><span class="nick" style="color:#389600"><a href="#232601" label="[23:26:01]">&lt;stikonas&gt;</a></span><span class="message"> <a rel="nofollow" href="https://paste.debian.net/1303183/">https://paste.debian.net/1303183/</a> </span></div><div class="line" id="232841"><span class="nick" style="color:#389600"><a href="#232841" label="[23:28:41]">&lt;stikonas&gt;</a></span><span class="message">hmm, the only thing that could really break unlink is if somehow access interferes with it</span></div><div class="line" id="232915"><span class="nick" style="color:#389600"><a href="#232915" label="[23:29:15]">&lt;stikonas&gt;</a></span><span class="message">oh, maybe it does</span></div><div class="line" id="232931"><span class="nick" style="color:#389600"><a href="#232931" label="[23:29:31]">&lt;stikonas&gt;</a></span><span class="message">I don't close the file on failure of access()!</span></div><div class="line" id="233019"><span class="nick" style="color:#389600"><a href="#233019" label="[23:30:19]">&lt;stikonas&gt;</a></span><span class="message">hmm</span></div><div class="line" id="233027"><span class="nick" style="color:#389600"><a href="#233027" label="[23:30:27]">&lt;stikonas&gt;</a></span><span class="message">btu that can't be true...</span></div><div class="line" id="233033"><span class="nick" style="color:#389600"><a href="#233033" label="[23:30:33]">&lt;stikonas&gt;</a></span><span class="message">it's NULL on failure...</span></div><div class="line" id="233105"><span class="nick" style="color:#6b8072"><a href="#233105" label="[23:31:05]">&lt;oriansj&gt;</a></span><span class="message">umm open can return more than just null on failure</span></div><div class="line" id="233208"><span class="nick" style="color:#6b8072"><a href="#233208" label="[23:32:08]">&lt;oriansj&gt;</a></span><span class="message">On error, -1 is returned and errno is set to indicate the error</span></div><div class="line" id="233210"><span class="nick" style="color:#389600"><a href="#233210" label="[23:32:10]">&lt;stikonas&gt;</a></span><span class="message">it should return fd <a rel="nofollow" href="https://github.com/oriansj/M2libc/blob/main/fcntl.c">https://github.com/oriansj/M2libc/blob/main/fcntl.c</a> </span></div><div class="line" id="233220"><span class="nick" style="color:#6b8072"><a href="#233220" label="[23:32:20]">&lt;oriansj&gt;</a></span><span class="message">not null</span></div><div class="line" id="233226"><span class="nick" style="color:#389600"><a href="#233226" label="[23:32:26]">&lt;stikonas&gt;</a></span><span class="message">oh yes...</span></div><div class="line" id="233228"><span class="nick" style="color:#389600"><a href="#233228" label="[23:32:28]">&lt;stikonas&gt;</a></span><span class="message">-1</span></div><div class="line" id="233238"><span class="nick" style="color:#389600"><a href="#233238" label="[23:32:38]">&lt;stikonas&gt;</a></span><span class="message">I must have missed that when I switched from fopen to open...</span></div><div class="line" id="233602"><span class="nick" style="color:#6b8072"><a href="#233602" label="[23:36:02]">&lt;oriansj&gt;</a></span><span class="message">so you will want if(0 &gt; rval);</span></div><div class="line" id="233700"><span class="nick" style="color:#6b8072"><a href="#233700" label="[23:37:00]">&lt;oriansj&gt;</a></span><span class="message">it'll make sense if the kernel/firmware encodes the error reason in the negative value returned.</span></div><div class="line" id="233732"><span class="nick" style="color:#389600"><a href="#233732" label="[23:37:32]">&lt;stikonas&gt;</a></span><span class="message">the problem is that UEFI doens't encode the reason...</span></div><div class="line" id="233746"><span class="nick" style="color:#389600"><a href="#233746" label="[23:37:46]">&lt;stikonas&gt;</a></span><span class="message">well, but since the problem is in access</span></div><div class="line" id="233752"><span class="nick" style="color:#389600"><a href="#233752" label="[23:37:52]">&lt;stikonas&gt;</a></span><span class="message">maybe I should try to completely rework that</span></div><div class="line" id="233815"><span class="nick" style="color:#389600"><a href="#233815" label="[23:38:15]">&lt;stikonas&gt;</a></span><span class="message">hmm, or maybe it's not in access...</span></div><div class="line" id="233844"><span class="nick" style="color:#389600"><a href="#233844" label="[23:38:44]">&lt;stikonas&gt;</a></span><span class="message">maybe it's again something in if((flag &amp; O_WRONLY) || (flag &amp; O_RDWR))</span></div><div class="line" id="233917"><span class="nick" style="color:#389600"><a href="#233917" label="[23:39:17]">&lt;stikonas&gt;</a></span><span class="message">hmm, I should just encode those two options that we use</span></div><div class="line" id="234112"><span class="nick" style="color:#389600"><a href="#234112" label="[23:41:12]">&lt;stikonas&gt;</a></span><span class="message">yeah, i think that's wrong logic...</span></div><div class="line" id="234325"><span class="nick" style="color:#6b8072"><a href="#234325" label="[23:43:25]">&lt;oriansj&gt;</a></span><span class="message">well yeah: flag &amp; O_WRONLY would set a bit if there is a match and true is zero</span></div><div class="line" id="234601"><span class="nick" style="color:#389600"><a href="#234601" label="[23:46:01]">&lt;stikonas&gt;</a></span><span class="message">true</span></div><div class="line" id="234611"><span class="nick" style="color:#389600"><a href="#234611" label="[23:46:11]">&lt;stikonas&gt;</a></span><span class="message">but something more tricky might be going on</span></div><div class="line" id="234617"><span class="nick" style="color:#389600"><a href="#234617" label="[23:46:17]">&lt;stikonas&gt;</a></span><span class="message">so before bit thing was fixed</span></div><div class="line" id="234624"><span class="nick" style="color:#389600"><a href="#234624" label="[23:46:24]">&lt;stikonas&gt;</a></span><span class="message">we were opening access as read only</span></div><div class="line" id="234636"><span class="nick" style="color:#389600"><a href="#234636" label="[23:46:36]">&lt;stikonas&gt;</a></span><span class="message">perhaps &quot;incorrectly&quot;</span></div><div class="line" id="234646"><span class="nick" style="color:#389600"><a href="#234646" label="[23:46:46]">&lt;stikonas&gt;</a></span><span class="message">and then fdopen switched to &quot;w&quot; mode</span></div><div class="line" id="234744"><span class="nick" style="color:#389600"><a href="#234744" label="[23:47:44]">&lt;stikonas&gt;</a></span><span class="message">but fdopen does not call any UEFI stuff</span></div><div class="line" id="234933"><span class="nick" style="color:#6b8072"><a href="#234933" label="[23:49:33]">&lt;oriansj&gt;</a></span><span class="message">well yes, because fdopen assumes one used mktemp to get the file descriptor</span></div><div class="line" id="235011"><span class="nick" style="color:#6b8072"><a href="#235011" label="[23:50:11]">&lt;oriansj&gt;</a></span><span class="message">otherwise why would one use fdopen instead of fopen?</span></div><div class="line" id="235047"><span class="nick" style="color:#389600"><a href="#235047" label="[23:50:47]">&lt;stikonas&gt;</a></span><span class="message">yes, but I'm trying to understand what breaks unlink()...</span></div><div class="line" id="235100"><span class="nick" style="color:#389600"><a href="#235100" label="[23:51:00]">&lt;stikonas&gt;</a></span><span class="message">i.e. is something left open...</span></div><div class="line" id="235343"><span class="nick" style="color:#6b8072"><a href="#235343" label="[23:53:43]">&lt;oriansj&gt;</a></span><span class="message">stikonas: is it in your posix kernel where unlink broke?</span></div><div class="line" id="235353"><span class="nick" style="color:#389600"><a href="#235353" label="[23:53:53]">&lt;stikonas&gt;</a></span><span class="message">oriansj: no, it's in UEFI</span></div><div class="line" id="235401"><span class="nick" style="color:#389600"><a href="#235401" label="[23:54:01]">&lt;stikonas&gt;</a></span><span class="message">stage0-uefi itself does not complete</span></div><div class="line" id="235411"><span class="nick" style="color:#389600"><a href="#235411" label="[23:54:11]">&lt;stikonas&gt;</a></span><span class="message">sorry, I wasn't clera</span></div><div class="line" id="235632"><span class="nick" style="color:#389600"><a href="#235632" label="[23:56:32]">&lt;stikonas&gt;</a></span><span class="message">i.e. something there was relying on that flag == O_WRONLY|O_CREAT|O_TRUNC bug</span></div><br /></div></body></html>